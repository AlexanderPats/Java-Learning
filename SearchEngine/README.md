# Итоговый проект курса «Java-разработчик» от Skillbox <br>«Локальный поисковый движок по сайтам»

Настоящий проект реализует поисковый движок по сайтам, указанным в конфигурационном файле.

Принципы работы поискового движка:

1. В конфигурационном файле перед запуском приложения задаются адреса сайтов, по которым движок должен осуществлять поиск.
2. Поисковый движок обходит страницы заданных сайтов и индексирует их (создает индекс) так, 
чтобы потом находить наиболее релевантные страницы по любому поисковому запросу. 
Также реализована индексация отдельной страницы по запросу от пользователя через API движка - WEB-интерфейс.
3. Поисковые запросы направляются пользователем через API движка. Запрос - это набор слов, по которым нужно найти страницы сайта.\
`ℹ️ Т.к. техническое задание к проекту не требовало реализация поиска английских слов, в проекте реализован только поиск по словам русского языка.
Слова, написанные латинскими символами, в запросе будут проигнорированы.`
4. Запрос трансформируется в список слов, переведённых в базовую форму - леммы.
5. В индексе производится поиск страниц, на которых встречаются все эти слова.
6. Результаты поиска ранжируются, сортируются и отдаются пользователю. Отображаемый пользователю результат содержит перечень страниц, удовлетворяющих поисковому запросу, 
с отображением названия сайта, заголовка страницы, сниппета. Название сайта и заголовок страницы содержат гиппер-ссылку на найденную страницу.
7. Дополнительно движок реализует вывод статистики индексации сайтов на WEB-страницу интерфейса пользователя.

Проект разработан на основе фреймворка Spring Boot, использует библиотеку миграции баз данных liquibase и библиотеки лемматизатора org.apache.lucene.morphology.
Содержит несколько контроллеров, сервисов и репозиториев с подключением к БД MySQL.

## Настройки для запуска

### Зависимости

Для успешного скачивания и подключения к проекту зависимостей
из GitHub необходимо настроить Maven конфигурацию в файле `settings.xml`.

А зависимостях, в файле `pom.xml` добавлен репозиторий для получения
jar файлов:
```xml
<repositories>
  <repository>
    <id>skillbox-gitlab</id>
    <url>https://gitlab.skillbox.ru/api/v4/projects/263574/packages/maven</url>
  </repository>
</repositories>
```
Для доступа требуется авторизация по токену для получения данных из публичного репозитория.\
Для указания токена, найдите файл `settings.xml`:.
* В Windows он располагается в директории `C:/Users/<Имя вашего пользователя>/.m2`
* В Linux директория `/home/<Имя вашего пользователя>/.m2`
* В macOs по адресу `/Users/<Имя вашего пользователя>/.m2`
и добавьте внутри тега `<value>`.
>**Внимание!** Актуальный токен, строка которую надо вставить в тег `<value>...</value>`
[находится в документе по ссылке](https://docs.google.com/document/d/1rb0ysFBLQltgLTvmh-ebaZfJSI7VwlFlEYT9V5_aPjc/edit?usp=sharing). 

❗️Если файла нет, то создайте `settings.xml` и вставьте в него:
```xml
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
 https://maven.apache.org/xsd/settings-1.0.0.xsd">

  <servers>
    <server>
      <id>skillbox-gitlab</id>
      <configuration>
        <httpHeaders>
          <property>
            <name>Private-Token</name>
            <value>token</value>
          </property>
        </httpHeaders>
      </configuration>
    </server>
  </servers>

</settings>
```
ℹ️ [Пример готового settings.xml лежит](settings.xml) в корне этого проекта.
**Не забудьте поменять токен на актуальный!**

### Настройки подключения к БД

В проект добавлен драйвер для подключения к БД MySQL. Для запуска проекта, убедитесь, что у вас запущен сервер MySQL 8.x.

Параметры подключения указаны в файле `src\main\resources\application.yml`:
```yaml
spring:
  datasource:
    username: 
    password: 
    url:
```
При необходимости откорректируйте учетные данные и адрес сервера БД в соответствии с конфигурацией используемой СУБД MySQL.

Приложение использует схему `serch_engine`.\
Если данная схема отсутствует в БД, то она будет создана при запуске проекта средствами библиотеки `liquibase`.
Также в случае отсутствия будут созданы все необходимые таблицы.\
Структура БД описана в конфигурационных файлах, находящихся в директории `src\main\resources\db\changelog\`

>**️❗️ Важно!** Структура схемы `serch_engine` должна соответствовать структуре, описанной в вышеуказанных конфигурационных файлах.\
Если в схеме `serch_engine` уже существуют таблицы с теми же названиями, но отличной структурой от указанной в конфигурационных файлах, 
корректная работа приложения будет невозможной!\
В этом случае рекомендуется заменить название схемы БД в файле `src\main\resources\application.yml`:\
spring:\
&emsp;datasource:\
&emsp;&emsp;url:\
для создание новой схемы.

## Структура проекта

### Начальная конфигурация

Для начальной конфигурации проекта используется файл `src\main\resources\application.yml`.\
В разделе `server:` указывается TCP-порт, который будет слушать WEB-сервер нашего приложения.\
В разделе `spring:` указываются настройки подключения к БД (см. раздел [Настройки подключения к БД](#настройки-подключения-к-бд)).\
В разделе `loging:` указываются настройки логирования (путь к файлу с логами, уровни логирования и формат лог-сообщений).\
В разделе `indexing-settings:` указываются параметры работы приложения при индексации сайтов. (см. раздел [Параметры индексации сайтов](#параметры-индексации-сайтов))

#### Параметры индексации сайтов
Параметры индексации сайтов задаются в конфигурационном файле `src\main\resources\application.yml` в секции `indexing-settings:`.
Используемые параметры:.\
`exclude-url-parameters:` - параметр, определяющий игнорирование параметров в адресе индексируемой страницы. Принимает значения true или false.
В случае установки значения true, параметры будут удаляться из адреса страницы.\
`path-max-length:` - параметр, определяющий максимальную длину относительного пути страницы. Если индексируемая страница имеет относительный путь более длинный, 
чем указанно в данном параметре, то ее индексации проводиться не будет. Максимальное допустимое значение равно 767. 
Это связано с внутренними ограничениями СУБД MySQL, а именно, с максимально-допустимым размером индекса.\
`user-agent:` - строка, которая будет вставлена в качестве идентификационной строки клиентского приложения в HTTP-запросах. 
Используется при индексации сайтов для предотвращения блокировок со стороны WEB-серверов.\
`referrer:` - URL, который будет вставлен в соответствующий заголовок HTTP-запроса при индексации главных страниц сайтов 
(для прочих страниц в качестве referrer будет подставлен URL страницы, на которой был встречен адрес текущей индексируемой страницы). 
Используется для предотвращения блокировок со стороны WEB-серверов.\
`request-timeout:` - интервал в миллисекундах между запросами к одному и тому же сайту в ходе индексации.
Используется для предотвращения блокировок со стороны WEB-серверов.\
`check-visited-pages-algorithm:` - параметр определяющий способ проверки, встречался ли адрес текущей страницы ранее в ходе индексации. 
Может принимать значения `0` или `1`. В случае значения `0` для каждого индексируемого сайта будет создан специальный Set, 
куда будут заноситься адреса посещенных страниц. Адрес каждой страницы перед парсингом и сохранением в БД будет проверен на наличие в данном Set'е.
Если в параметре указано значение `1`, адрес страницы перед парсингом и сохранением в БД будет проверятся на наличие в самой БД с помощью соответствующего запроса.
Последний алгоритм крайне неэффективен по сравнению с первым. Он позволяет сэкономить незначительный объем оперативной памяти,
при этом значительно проигрывает по скорости. Его реализация оставлена в проекте только потому, что такой алгоритм проверки был указан в техническом задании на проект.\
`sites:` - перечень сайтов, которые будут индексироваться, и по которым можно направлять поисковые запросы. 
Поисковые запросы по сайтам, отсутствующим в данном списке, не поддерживаются.

Перечень сайтов задается в следующем формате:
```yaml
    - url: http://affix.ru
      name: Affix	  
```
За обработку параметров индексации сайтов отвечает пакет `config`.

### Слой представления (Presentation Layer)

Данный слой отвечает за взаимодействие с front-end составляющей приложения. В качестве API взаимодействия используются HTTP-запросы и ответы.
За реализацию слоя отвечают пакеты `controllers` и `dto`. В первом пакете реализованы два контроллера. 
DefaultController отвечает за запуск Front-end составляющей. ApiController ожидает запросы по API от front-end составляющей и отдает ответы. 
Во втором пакете описывается структура сообщений, которые возвращает ApiController.

### Слой бизнес-логики (Business Layer)

Данный слой реализует основную логику работы приложения. Слой реализован в пакете `services`, который в свою очередь включает в себя следующие пакеты:\
`crud` - содержит реализацию методов получения данных из БД, а также методов сохранения или изменения данных в БД.\
`indexing` - содержит реализацию индексации сайтов и отдельных WEB-страниц.\
`morfology` - содержит реализацию лемматизации (делит заданный текст на слова, каждое слова переводит в нормальную форму - лемму, 
подсчитывает количество каждой леммы в тексте).\
`search` - содержит реализацию поиска слов из заданного запроса на страницах проиндексированных сайтов, отвечает за формирование тела сообщения с результатом поиска\
`statistics` - содержит реализацию расчета статистики индексации сайтов, отвечает за формирование тела сообщения со статистической информацией.

### Слой доступа к данным (Data Access Layer)

Слой отвечает за хранение данных, подключение к БД, реализацию запросов. Данный слой реализован в двух пакетах:\
`model` - содержит описание классов-сущностей (entities), связанных с таблицами БД.\
С учетом того, что в проекте используется библиотека `liquibase`, некоторые элементы описания структуры таблиц БД (включая описание типов полей таблиц, 
а также индексов и внешних ключей) в классах-сущностях являются избыточными, тем не менее решено оставить эти элементы для более удобного восприятия структуры БД через 
чтение исходного кода, а также для случая, если по каким-либо причинам в будущем будет решено отказаться от использования библиотеки `liquibase`.\
`repositories` - содержит репозитории, обеспечивающие взаимодействие с таблицами БД, реализующие запросы к БД для получения, сохранения или модификации данных.
